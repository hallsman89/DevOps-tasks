# S21_SimpleDocker

## Part1. Ready-made docker

* Возьмемо официальный docker-образ с nginx и выкачаем его при помощи команды `docker pull` 
![100.jpg](img/100.jpg)

* Далее удостоверимся в наличии образа через команду `docker images` 
![101.jpg](img/101.jpg)

* Наконец, запустим docker-образ через команду `docker run -d [image_id|repository]` 
![102.jpg](img/102.jpg)
```
-d: это флаг, который указывает Docker на запуск контейнера в фоновом режиме (detached mode). Это означает, что контейнер будет работать в фоновом режиме, и командная строка будет освобождена для дальнейшего использования.
```

* Удостоверимся, что контейнер успешно запустился через команду `docker ps` 
![103.jpg](img/103.jpg)

* Теперь посмотрим информацию о контейнере через команду `docker inspect [container_id|container_name]` 
![104.jpg](img/104.jpg)

* Выведем размер контейнера  
![105.jpg](img/105.jpg)

* А теперь - список замапленных портов  
![106.jpg](img/106.jpg)

* И, наконец, IP контейнера  
![107.jpg](img/107.jpg)

* Остановим docker-образ командой `docker stop [container_id|container_name]` и проверим, что образ успешно остановился через команду `docker ps` 
![108.jpg](img/108.jpg)

* Теперь запустим docker-образ с портами 80:80 и 443:443 через команду `docker run` 
![109.jpg](img/109.jpg)

* Удостоверимся, что все работает, открыв в браузере страницу по адресу `localhost` 
![110.jpg](img/110.jpg)

* Наконец, перезапустим контейнер через команду `docker restart [container_id|container_name]` и проверим, что контейнер снова запустился командой `docker ps` 
![111.jpg](img/111.jpg)

# Part2. Operations with container

* Для начала прочтем конфигурационный файл `nginx.conf` внутри docker-контейнера через команду `docker exec` 
![200.jpg](img/200.jpg)

* Теперь создадим локальный файл `nginx.conf` при помощи команды `touch nginx.conf` и настроем в нем выдачу страницы-статуса сервера по пути `/status` 
![201.jpg](img/201.jpg)

* Наконец, перенесем созданный файл внутрь docker-образа командой `docker cp` 
![202.jpg](img/202.jpg)

* И перезапустим nginx внутри docker-образа командой `docker exec [container_id|container_name] nginx -s reload` 
![203.jpg](img/203.jpg)

* Убедимся, что все работает, проверив страницу по адресу `localhost/status` 
![204.jpg](img/204.jpg)

* Теперь экспортируем наш контейнер в файл `container.tar` командой `docker export` 
![205.jpg](img/205.jpg)

* Затем удалим образ командой `docker rmi -f [image_id|repository]`, не удаляя перед этим контейнеры 
![206.jpg](img/206.jpg)

* После чего удалим остановленный контейнер командой `docker rm [container_id|container_name]` 
![207.jpg](img/207.jpg)

* Теперь импортируем контейнер обратно командой `docker import` и запустим импортированный контейнер уже знакомой командой `dicker run` 
![208.jpg](img/208.jpg)

* Наконец проверим, что по адресу `localhost/status` выдается страничка со статусом сервера nginx 
![209.jpg](img/209.jpg)

## Part3. Mini web server

* Чтобы создать свой мини веб-сервер, необходимо создать .c файл, в котором будет описана логика сервера (в нашем случае - вывод сообщения `Hello World!`), а также конфиг `nginx.conf`, который будет проксировать все запросы с порта 81 на порт 127.0.0.1:8080 
![300.jpg](img/300.jpg) 
![301.jpg](img/301.jpg)

* Теперь выкачаем новый docker-образ и на его основе запустим новый контейнер 
![302.jpg](img/302.jpg)

* После перекинем конфиг и логику сервера в новый контейнер 
![303.jpg](img/303.jpg)

* Затем установим требуемые утилиты для запуска мини веб-сервера на FastCGI, в частности `spawn-fcgi` и `libfcgi-dev` 
![304.jpg](img/304.jpg)

* Наконец скомпилируем и запустим наш мини веб-сервер через команду `spawn-fcgi` на порту 8080 
![305.jpg](img/305.jpg)

* Чтобы удостовериться, что все работает корректно, проверим, что в браузере по адресу `localhost:81` отдается написанная нами страница 
![306.jpg](img/306.jpg)


## Part4. Your own docker

* Напишем свой docker-образ, который собирает исходники 3-й части, запускает на порту `80`, после копирует внутрь написанный нами `nginx.conf` и, наконец, запускает `nginx` (ниже приведены файлы `run.sh` и `Dockerfile`, файлы `nginx.conf` и `server.c` остаются с 3-й части)

![400.jpg](img/400.jpg)  
![401.jpg](img/401.jpg)  

* Соберем написанный docker-образ через команду `docker build`, при этом указав имя и тэг нашего контейнера  
![402.jpg](img/402.jpg)  

* Теперь удостоверимся, что все собралось, проверив наличие соответствующего образа командой `docker images`  
![403.jpg](img/403.jpg)  

* После запустим собранный docker-образ с мапингом порта `81` на порт `80` локальной машины, а также мапингом папки `./nginx` внутрь контейнера по адресу конфигурационных файлов nginx'а, и проверим, что страничка написанного сервера по адресу 
![404.jpg](img/404.jpg)
![404-1.jpg](img/404-1.jpg)

```
!!Примечание!!
Если при проверке адреса localhost вы увидете ошибку 502, остановите запущенный docker-образ, после исправьте ошибки в конфигурационных файлах и заново запустите собранный docker-образ
```

* Теперь добавим в файл `nginx.conf` проксирование странички `/status`, по которой необходимо отдавать статус сервера `nginx  
![405.jpg](img/405.jpg)

* Теперь перезапустим `nginx` в своем docker-образе командой `nginx -s reload`  
![406.jpg](img/406.jpg)

* Наконец, проверим, что по адресу `localhost/status` выдается страничка со тсатусом сервера `nginx`  
![407.jpg](img/407.jpg)


## Part5. Dockle

```
!!Примечание!!
Перед выполнением данного шага необходимо установить утилиту [dockle], инструкция по установке [https://github.com/goodwithtech/dockle], если машина не видит утилиту [https://github.com/aquasecurity/trivy/issues/2432], также рекомендую добавить своего пользователя в группу [docker]
```

* сперва установим dockle  
![500.jpg](img/500.jpg)  

* потом проверим образ  
![501.jpg](img/501.jpg)  

* переписываем докерфайл  
![502.jpg](img/502.jpg)  

* Ошибки устранены
![503.jpg](img/503.jpg)  

## Part6. Basic Docker Compose

```
!!Примечание!!
Перед выполнением данного шага необходимо установить утилиту [docker-compose], инструкция по установке [https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-compose-on-ubuntu-20-04]
```

* Для начала остановим все запущенные контейнеры командой `docker stop`  
![600.jpg](img/600.jpg)

* Перепишем скрипт run для второго контейнера
![601.jpg](img/601.jpg)

* Перепишем _**nginx.conf**_ для проксирования  
![602.jpg](img/602.jpg) 

* напишем **_docker-compose.yml_**  
![603.jpg](img/603.jpg)  

* Теперь сбилдим контейнер командой `docker-compose build`
![604.jpg](img/604.jpg)  

* После необходимо поднять сбилженный контейнер командой `docker compose up`
![605.jpg](img/605.jpg) 

* проверяем в браузере

![606.jpg](img/606.jpg) 
![607.jpg](img/607.jpg)  
